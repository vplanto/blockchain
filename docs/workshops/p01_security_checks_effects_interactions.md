# –ü—Ä–∞–∫—Ç–∏–∫—É–º p01. –ë–µ–∑–ø–µ–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤: reentrancy —Ç–∞ –ø–∞—Ç–µ—Ä–Ω CEI

**–ú–µ—Ç–∞:** –†–æ–∑—ñ–±—Ä–∞—Ç–∏ –Ω–∞ –ø—Ä–∏–∫–ª–∞–¥–∞—Ö, —á–æ–º—É –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π —É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ –≤–∞–∂–ª–∏–≤–∏–π, —ñ —è–∫ –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏—Å—è –≤—ñ–¥ reentrancy. –ú–∞—Ç–µ—Ä—ñ–∞–ª –æ–ø–∏—Ä–∞—î—Ç—å—Å—è –Ω–∞ [case_studies.md](../case_studies.md) (The DAO, EIP-6110).

---

## –ü–∏—Ç–∞–Ω–Ω—è –¥–ª—è –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è

1. –ß–∏ –º–æ–∂–µ —Ñ—É–Ω–∫—Ü—ñ—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —ñ–Ω—à–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç? –©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑ –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥ —á–∞—Å —Ç–∞–∫–æ–≥–æ –≤–∏–∫–ª–∏–∫—É?
2. –ß–æ–º—É "—Å–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–∫–∞–∑–∞—Ç–∏ –≥—Ä–æ—à—ñ, –ø–æ—Ç—ñ–º –æ–Ω–æ–≤–∏—Ç–∏ –±–∞–ª–∞–Ω—Å" ‚Äî –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ?
3. –©–æ —Ç–∞–∫–µ "fallback" —Ñ—É–Ω–∫—Ü—ñ—è —ñ –∫–æ–ª–∏ –≤–æ–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è?

---

## 1. –ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è: The DAO (Case #002)

–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –≤ [case_studies.md](../case_studies.md) —Ä–æ–∑–¥—ñ–ª "Case #002: The DAO Hack". –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ –≤—Ä–∞–∑–ª–∏–≤–∏–π –ø–æ—Ä—è–¥–æ–∫: —Å–ø–æ—á–∞—Ç–∫—É `transfer` (–∑–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–∫–ª–∏–∫), –ø–æ—Ç—ñ–º `credit[msg.sender] -= amount`. –ê—Ç–∞–∫—É—é—á–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç —É fallback –∑–Ω–æ–≤—É –≤–∏–∫–ª–∏–∫–∞—î `withdraw` ‚Äî —ñ –æ—Ç—Ä–∏–º—É—î –≥—Ä–æ—à—ñ –ø–æ–≤—Ç–æ—Ä–Ω–æ, –±–æ –±–∞–ª–∞–Ω—Å —â–µ –Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–æ.

---

## 2. –ü–∞—Ç–µ—Ä–Ω Checks-Effects-Interactions (CEI)

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ —É —Ñ—É–Ω–∫—Ü—ñ—ó:

1. **Checks:** –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (`require`, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å—ñ–≤, –ø—Ä–∞–≤).
2. **Effects:** –∑–º—ñ–Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —Å—Ç–∞–Ω—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É (–±–∞–ª–∞–Ω—Å–∏, –ø—Ä–∞–ø–æ—Ä—Ü—ñ, –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏).
3. **Interactions:** –∑–æ–≤–Ω—ñ—à–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ (transfer, –≤–∏–∫–ª–∏–∫ —ñ–Ω—à–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É).

–Ø–∫—â–æ —Å–ø–æ—á–∞—Ç–∫—É –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω, –∞ –≤–∂–µ –ø–æ—Ç—ñ–º —Ä–æ–±–∏—Ç–∏ transfer, –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤—Ö—ñ–¥ (reentrancy) –ø–æ–±–∞—á–∏—Ç—å —É–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å —ñ –Ω–µ –∑–º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥—Ä–æ—à—ñ –≤–¥—Ä—É–≥–µ.

---

## 3. –ó–∞–≤–¥–∞–Ω–Ω—è –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è –∫–æ–¥—É

–£ –±—É–¥—å-—è–∫–æ–º—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ –∑ –ø–µ—Ä–µ–∫–∞–∑–æ–º –∫–æ—à—Ç—ñ–≤ (–∞–±–æ –∑ –≤–∏–∫–ª–∏–∫–æ–º –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É) –∑–Ω–∞–π–¥—ñ—Ç—å —É –∫–æ–¥—ñ (–∞–±–æ –Ω–∞ —É–º–æ–≤–Ω–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ):

- –î–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–∫–ª–∏–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `transfer`, `call`, `send`)?
- –î–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å—Ç–∞–Ω (mapping –±–∞–ª–∞–Ω—Å—ñ–≤, –ø—Ä–∞–ø–æ—Ä–∏)?
- –ß–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –¥–æ —á–∏ –ø—ñ—Å–ª—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—É? –Ø–∫—â–æ –ø—ñ—Å–ª—è ‚Äî —Ü–µ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∞ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –¥–æ reentrancy.

---

## 4. –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∑–∞—Ö–∏—Å—Ç: nonReentrant

–£ —Ä–µ–∞–ª—å–Ω–∏—Ö –ø—Ä–æ—î–∫—Ç–∞—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, OpenZeppelin `ReentrancyGuard`): –ø—Ä–∞–ø–æ—Ä–µ—Ü—å "—Ñ—É–Ω–∫—Ü—ñ—è –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è" –±–ª–æ–∫—É—î –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤—Ö—ñ–¥. –†–æ–∑—É–º—ñ–Ω–Ω—è CEI –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –∫—É—Ä—Å—É; –ø—Ä–æ nonReentrant –º–æ–∂–Ω–∞ –∑–≥–∞–¥–∞—Ç–∏ —è–∫ –ø—Ä–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —à–∞—Ä –∑–∞—Ö–∏—Å—Ç—É.

---

## –ü–∏—Ç–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–µ–∫–∑–∞–º–µ–Ω–∞—Ü—ñ–π–Ω–∏–π –±–ª–æ–∫)

**–ü1.** –©–æ —Ç–∞–∫–µ reentrancy —ñ —è–∫ –∞—Ç–∞–∫—É—é—á–∏–π –º–æ–∂–µ –π–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏?

**–í1.** Reentrancy ‚Äî —Å–∏—Ç—É–∞—Ü—ñ—è, –∫–æ–ª–∏ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∞—à–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –≤–∏ —Ä–æ–±–∏—Ç–µ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–∫–ª–∏–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–µ—Ä–µ–∫–∞–∑ ETH –Ω–∞ —ñ–Ω—à–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç), –∞ —Ç–æ–π —É —Å–≤–æ—ó–π fallback-—Ñ—É–Ω–∫—Ü—ñ—ó –∑–Ω–æ–≤—É –≤–∏–∫–ª–∏–∫–∞—î –≤–∞—à—É —Ñ—É–Ω–∫—Ü—ñ—é. –Ø–∫—â–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å—Ç–∞–Ω (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±–∞–ª–∞–Ω—Å "–∫—Ä–µ–¥–∏—Ç—É") –æ–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∫–∞–∑—É, –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –≤—Ö–æ–¥—ñ –∫–æ–Ω—Ç—Ä–∞–∫—Ç —â–µ "–¥—É–º–∞—î", —â–æ —É –≤–∏–∫–ª–∏–∫–∞—á–∞ —î –±–∞–ª–∞–Ω—Å, —ñ –º–æ–∂–µ –ø–µ—Ä–µ–∫–∞–∑–∞—Ç–∏ –≥—Ä–æ—à—ñ –∑–Ω–æ–≤—É. –¢–∞–∫ –≤–∏–Ω–∏–∫–∞—î –¥—Ä–µ–Ω—ñ–Ω–≥ –∫–æ—à—Ç—ñ–≤.

---

**–ü2.** –Ø–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π —É –ø–∞—Ç–µ—Ä–Ω—ñ Checks-Effects-Interactions —ñ –Ω–∞–≤—ñ—â–æ –≤—ñ–Ω –ø–æ—Ç—Ä—ñ–±–µ–Ω?

**–í2.** –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (checks), –ø–æ—Ç—ñ–º –∑–º—ñ–Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —Å—Ç–∞–Ω—É (effects), –≤ –∫—ñ–Ω—Ü—ñ ‚Äî –∑–æ–≤–Ω—ñ—à–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ (interactions). –ü–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ reentrancy: —è–∫—â–æ —Å—Ç–∞–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—É, –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤—Ö—ñ–¥ –ø–æ–±–∞—á–∏—Ç—å —É–∂–µ –∑–º–µ–Ω—à–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å —ñ –Ω–µ –∑–º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—à—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ.

---

**–ü3.** –©–æ —Ç–∞–∫–µ fallback-—Ñ—É–Ω–∫—Ü—ñ—è –≤ Solidity —ñ –∫–æ–ª–∏ –≤–æ–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è?

**–í3.** Fallback ‚Äî —Ñ—É–Ω–∫—Ü—ñ—è –±–µ–∑ —ñ–º–µ–Ω—ñ (–∞–±–æ `receive` –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è ETH), —è–∫–∞ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –∫–æ–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –æ—Ç—Ä–∏–º—É—î –≤–∏–∫–ª–∏–∫ –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –∂–æ–¥–Ω—ñ–π —ñ–º–µ–Ω–æ–≤–∞–Ω—ñ–π —Ñ—É–Ω–∫—Ü—ñ—ó, –∞–±–æ –∫–æ–ª–∏ –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å ETH. –ê—Ç–∞–∫—É—é—á–∏–π –º–æ–∂–µ –ø–æ–º—ñ—Å—Ç–∏—Ç–∏ –≤ fallback –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤–∏–∫–ª–∏–∫ –≤–∞—à–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É ‚Äî —Ü–µ –æ—Å–Ω–æ–≤–∞ reentrancy-–∞—Ç–∞–∫–∏.

---

## üéì –Ü–Ω–∂–µ–Ω–µ—Ä–Ω–∏–π –º—ñ–Ω—ñ-–∫–µ–π—Å (–Ω–∞ 1 –±–∞–ª)

–†–æ–∑—Ä–æ–±–Ω–∏–∫ –Ω–∞–ø–∏—Å–∞–≤ —Ñ—É–Ω–∫—Ü—ñ—é `sellTokens(uint amount)`, —è–∫–∞ —Å–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç –≤ ETH (`payable(msg.sender).call{value: ethAmount}("")`), –∞ –ø–æ—Ç—ñ–º —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ä—è–¥–∫—É –∑–º–µ–Ω—à—É—î –π–æ–≥–æ –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω—ñ–≤ (`balances[msg.sender] -= amount`). –†–æ–∑—Ä–æ–±–Ω–∏–∫ —Å—Ç–≤–µ—Ä–¥–∂—É—î, —â–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç —É –±–µ–∑–ø–µ—Ü—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–¥ —Ü–∏–º–∏ —Ä—è–¥–∫–∞–º–∏ —Å—Ç–æ—ó—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ `require(balances[msg.sender] >= amount)`.
**–ü–∏—Ç–∞–Ω–Ω—è:** –ß–∏ —î —Ü–µ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤—Ä–∞–∑–ª–∏–≤–∏–º –¥–æ —è–∫–æ—ó—Å—å –∞—Ç–∞–∫–∏? –í—ñ–¥–ø–æ–≤—ñ–¥—å –æ–±“ë—Ä—É–Ω—Ç—É–π—Ç–µ, —Å–ø–∏—Ä–∞—é—á–∏—Å—å –Ω–∞ –ø–∞—Ç–µ—Ä–Ω CEI.
