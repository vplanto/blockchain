# Лекція 4. Алгоритми консенсусу: PoW та PoS у деталях

**Мета:** Розібрати механіку Proof of Work і Proof of Stake з точки зору безпеки та економіки (ігрова теорія).

Матеріали лекції 1 вже дали загальну картину (CFT vs BFT, pBFT, введення в PoW/PoS). Тут фокус на тому, як саме PoW і PoS захищають ланцюг і чому мережа "довіряє" найдовшому ланцюгу.

---

## Питання для обговорення

1. Чому "найдовший ланцюг" вважається правильним? Хто це вирішив?
2. Що дорожче для атакуючого: накупити обладнання для майнингу чи накупити монети для стейкінгу?
3. Що таке "finality" в блокчейні і чому в Bitcoin кажуть про "6 підтверджень"?

---

## 1. Proof of Work: механіка

Майнер підбирає nonce так, щоб хеш заголовка блоку (разом з nonce) був менший за ціль (target). Складність (difficulty) регулюється мережею так, щоб час між блоками був приблизно стабільним (у Bitcoin — близько 10 хвилин).

"One CPU = one vote" — це не голосування в сенсі pBFT, а внесок у роботу. Щоб переписати історію, треба мати більшу обчислювальну потужність, ніж чесна мережа. Що дорого: енергія та обладнання.

---

## 2. Probabilistic finality (Bitcoin)

У Bitcoin немає миттєвої "фінальності": блок можна відкинути, якщо з’явиться довший конкуруючий ланцюг (reorg). Що більше блоків "зверху", тим менша ймовірність, що хтось зможе побудувати довший альтернативний ланцюг. "6 підтверджень" — емпіричне правило: після шести блоків ймовірність відміни вважається дуже малою при розумних припущеннях про частку атакуючого хешрейту.

---

## 3. Proof of Stake: механіка

Валідатори блокують монети (stake). Право пропонувати блок і голосувати за нього залежить від частки стейку (і часто від випадковості, щоб уникнути передбачуваності). Якщо валідатор порушує правила (наприклад, підписує два різні блоки на одній висоті), його депозит може бути спалено (slashing). Це "застава": атакувати невигідно, бо втрачаєш гроші.

---

## 4. Nothing at Stake і як його вирішують

У "наївному" PoS валідатору може бути вигідно голосувати за кілька гілок одночасно (нічого не втрачає). Рішення: явні правила (наприклад, голосувати лише за один блок на висоті) і slashing за подвійне підписання. Тоді підтримка двох гілок загрожує втратою стейку.

---

## 5. Практика: симулятори

- [pow.html](./consensus/byzantine_algos/pow.html): змініть дані в блоці і подивіться, як ламається ланцюг; перемайніть блоки, щоб відновити валідність.
- [pos.html](./consensus/byzantine_algos/pos.html): спостерігайте за тим, як винагороди за стейкінг змінюють розподіл "багатства" між вузлами.

---

## Питання та відповіді (екзаменаційний блок)

**П1.** Як у PoW визначається, який блок "правильний"?

**В1.** Правильним вважається ланцюг з найбільшою сумарною складністю (найбільша "накопичена робота"). Вузли вибирають гілку з найдовшим (найважчим) ланцюгом. Атакуючий не може підробити його без більшої обчислювальної потужності, ніж у решти мережі.

---

**П2.** Що таке probabilistic finality і навіщо "6 підтверджень" у Bitcoin?

**В2.** У PoW немає миттєвої фінальності: теоретично можлива реорганізація, якщо з’явиться довший ланцюг. Що більше блоків "зверху", тим складніше атакуючому побудувати довший ланцюг. Шість блоків — емпірична межа, після якої ймовірність відміни вважають мізерною при типовій частці хешрейту атакуючого.

---

**П3.** Що таке slashing у PoS і навіщо він потрібен?

**В3.** Slashing — це штраф у вигляді конфіскації частини або всього стейку валідатора за порушення протоколу (наприклад, подвійне підписання блоків на одній висоті). Це робить атаку економічно невигідною і допомагає вирішити проблему "Nothing at Stake": невигідно підтримувати кілька гілок, бо можна втратити депозит.

---

**П4.** У чому різниця між "голосуванням" у pBFT і "голосуванням" у PoW?

**В4.** У pBFT вузли явно обмінюються повідомленнями "голос" (O(N²) повідомлень), і рішення детерміноване після збору достатньої кількості голосів. У PoW "голосування" — це внесок у обчислювальну роботу: хто перший знайшов валідний блок, той його пропонує. Немає явного обміну голосами; вибір гілки визначається правилом "найдовший ланцюг".
