# Лекція 3. Архітектура Ethereum: рахунки, EVM, газ

**Мета:** Зрозуміти, чому Ethereum обрали модель рахунків замість UTXO і як працює виконання коду (EVM, газ).

**Джерело:** Ethereum Yellow Paper (Gavin Wood).

---

## Питання для обговорення

1. Як би ви додали в Bitcoin логіку типу "переказ лише якщо двоє з трьох підписали"? Чи вистачає тільки скриптів?
2. Навіщо в Ethereum зберігати "баланс" і "nonce" для кожної адреси?
3. Хто платить за виконання коду на блокчейні і чому це не може бути безкоштовно?

---

## 1. Модель рахунків (Account model)

У Ethereum є глобальний стан: список адрес (accounts) із полями баланс (balance), nonce (лічильник транзакцій), код контракту (якщо є), зберігання (storage). Транзакція змінює цей стан: перекази змінюють баланси, виклик контракту виконує його код і може змінювати storage.

Чому не UTXO? Складні умови (мультипідпис, часові замки, умовні виплати) у скриптах Bitcoin обмежені й незручні для довільного коду. Модель рахунків з контрактами дозволяє зберігати стан і виконувати складну логіку. Ціна — кожен вузол повинен підтримувати і оновлювати глобальний стан.

---

## 2. EVM (Ethereum Virtual Machine)

EVM — стекова машина з байткодом. Контракт — це код (bytecode), який виконується при виклику транзакцією або іншим контрактом. Кожна операція (ADD, SSTORE, CALL тощо) коштує певну кількість **газу**. Транзакція вказує gas limit і gas price; якщо газу не вистачає до виконання, виконання відкочується (revert), а газ за спроби все одно сплачується.

Це захищає мережу від нескінченних циклів і "важких" контрактів: платиш за обчислення. Операції зі зберіганням (SSTORE) дорожчі за арифметику, щоб обмежити розмір стану.

---

## 3. Gas і fee

Gas — одиниця "роботи" EVM. Користувач задає gas price (наприклад, у gwei). Fee = gas used × gas price. Майнер (в PoW) або валідатор (в PoS) отримує цю плату. Чим вища ціна, тим швидше транзакцію включать у блок (при обмеженому місці в блоці).

---

## 4. State Trie

Стан Ethereum (баланси, nonce, код, storage контрактів) зберігається в структурах на основі Merkle Patricia Trie. Корінь цього дерева (state root) входить у заголовок блоку. Будь-яка зміна стану змінює корінь. Тому можна довести значення балансу або комірки storage без передачі всього стану (Merkle proof).

---

## 5. Порівняння з Bitcoin (коротко)

| Аспект | Bitcoin | Ethereum |
|--------|---------|----------|
| Модель даних | UTXO | Рахунки + стан контрактів |
| Скрипт/код | Обмежений Script | Повноцінний байткод (EVM) |
| "Гроші" | Лише перекази виходів | Перекази + виклики контрактів (gas) |
| Стан | Немає глобального балансу | Глобальний state trie |

---

## Питання та відповіді (екзаменаційний блок)

**П1.** Чому в Ethereum обрали модель рахунків, а не UTXO?

**В1.** Ethereum має за мету виконувати довільну логіку (смарт-контракти). Модель рахунків зі зберіганням (storage) і кодом контракту простіша для складних умов і стану. UTXO з скриптами (як у Bitcoin) не розраховані на такий обсяг логіки та зберігання даних.

---

**П2.** Що таке газ (gas) і навіщо він потрібен?

**В2.** Gas — одиниця виміру "роботи" EVM. Кожна операція має ціну в газі. Транзакція вказує gas limit і gas price. Це обмежує складність виконання (немає нескінченних циклів безкоштовно) і змушує платника платити за обчислення та зберігання. Fee = gas used × gas price йде майнеру/валідатору.

---

**П3.** Що таке EVM і який тип машини це?

**В3.** EVM (Ethereum Virtual Machine) — віртуальна машина зі стековою архітектурою, що виконує байткод смарт-контрактів. Кожна інструкція має вартість у газі. Вузли виконують один і той самий код і приходять до одного стану; якщо газу не вистачає, виконання відкочується (revert).

---

**П4.** Як пов’язані state root і Merkle (Patricia) trie в Ethereum?

**В4.** Глобальний стан (баланси, nonce, код, storage) зберігається в структурах на основі Merkle Patricia Trie. Корінь цього дерева (state root) записується в заголовок блоку. Зміна будь-якого значення змінює корінь. За допомогою Merkle proof можна довести значення комірки стану без передачі всього стану.
