# Лекція 2. Архітектура Bitcoin (модель UTXO)

**Мета:** Зрозуміти, як влаштований перший блокчейн на рівні даних і чому він обраний саме такий, а не "рахунки з балансами".

**Джерело:** Bitcoin Whitepaper (Satoshi Nakamoto, 2008).

---

## Питання для обговорення

1. Як ви уявили б "базу даних" грошей без банку: список рахунків із сумами чи щось інше?
2. Чому в Bitcoin немає поняття "номер рахунку"? Є лише адреси та транзакції.
3. Що означає "потратити" монету в системі без центрального сервера?

---

## 1. UTXO замість рахунків

У класичній банківській системі є рахунки (accounts) і баланс на кожному. Bitcoin не зберігає баланси. Він зберігає **невитрачені виходи транзакцій** (Unspent Transaction Outputs, UTXO).

Кожна транзакція споживає один або кілька виходів (inputs) і створює один або кілька нових виходів (outputs). "Баланс" гаманця — це сума всіх UTXO, що належать цій адресі (тобто ключу, який може їх підписати).

Чому так? Менше стану, який треба синхронізувати. Валідація транзакції — це перевірка підписів і витрат лише залучених виходів, без глобальної таблиці балансів.

---

## 2. Структура блоку

Блок в Bitcoin містить:

- **Заголовок (header):** версія, хеш попереднього блоку, корінь дерева Меркла транзакцій, час, складність (bits), nonce.
- **Список транзакцій:** перша — зазвичай coinbase (винагорода майнеру), решта — перекази.

Ланцюг блоків утворюється через поле "хеш попереднього блоку". Зміна будь-якого байту в минулому блоці змінює його хеш, тож ламається вся послідовність далі. Це і є "immutability" на рівні даних.

---

## 3. Merkle Tree

Транзакції в блоці не зберігаються як плоский список у заголовку. У заголовку зберігається лише **Merkle root** — корінь бінарного дерева хешів.

- Листя дерева — хеші транзакцій.
- Кожен батьківський вузол — хеш від конкатенації двох дітей (зазвичай SHA-256).

Що це дає: можна довести включення транзакції в блок, передавши лише шлях від листа до кореня (Merkle proof). Легкий клієнт (SPV) не завантажує всі транзакції, а запитує лише потрібні докази.

---

## 4. Скрипт (Script) і підписи

Виходи транзакції не зберігають "адресу одержувача" у вигляді одного числа. Вони зберігають **скрипт** (Script): набір інструкцій, при виконанні яких вихід вважається витраченим. Типовий випадок: "перевір підпис ECDSA для ключа, хеш якого дорівнює H". Тобто "володіти" виходом = мати секретний ключ, що відповідає цьому умові.

Bitcoin не використовує імена чи ID. Ідентифікація — криптографічна: хто знає секретний ключ, той може створити валідний підпис і витратити вихід.

---

## 5. Практика: симулятор PoW

Відкрийте [pow.html](./consensus/byzantine_algos/pow.html). Змініть суму в одній із транзакцій у блоці. Подивіться, як змінюються хеші по всьому ланцюгу. Це ілюстрація того, чому "переписати історію" дорого: треба перерахувати всі наступні блоки з новим nonce (Proof of Work).

---

## Питання та відповіді (екзаменаційний блок)

**П1.** Що таке UTXO і чому в Bitcoin не використовують модель "рахунок + баланс"?

**В1.** UTXO (Unspent Transaction Output) — це вихід транзакції, який ще ніхто не витратив. "Баланс" — сума всіх UTXO, що належать ключам користувача. Модель рахунків вимагала б глобального стану (всі баланси); UTXO дозволяє валідувати транзакцію лише за переліком виходів, які вона споживає, і перевіркою підписів.

---

**П2.** Яку роль відіграє Merkle Tree у блоці Bitcoin?

**В2.** У заголовку блоку зберігається лише корінь дерева Меркла (Merkle root). Листя — хеші транзакцій. Це дає можливість довести включення транзакції в блок без завантаження всього блоку (Merkle proof). Легкі клієнти (SPV) використовують це для економії трафіку та зберігання.

---

**П3.** Що таке "immutability" ланцюга блоків на технічному рівні?

**В3.** Кожен блок містить хеш попереднього блоку. Зміна будь-якого байту в минулому блоці змінює його хеш; наступні блоки посилаються на старий хеш, тому ланцюг стає невалідним. "Переписати" минуле можна лише перерахувавши всі наступні блоки (PoW), що економічно непрацездійно при достатній потужності мережі.

---

**П4.** Як у Bitcoin визначається "володіння" монетою?

**В4.** Монета (вихід транзакції) може бути витрачена лише якщо виконається умова скрипта цього виходу. У типових випадках скрипт вимагає коректний підпис ECDSA від секретного ключа, відповідного заданій адресі. Тобто володіти = знати секретний ключ і мати можливість створити валідний підпис.
